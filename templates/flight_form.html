{% extends "base.html" %}

{% block title %}{{ 'Edit Flight' if flight else 'Schedule Flight' }} - Manajet{% endblock %}

{% block content %}
<h1>{{ 'Edit Flight' if flight else 'Schedule New Flight' }}</h1>

{% if maintenance_warning %}
<div class="card" style="background: #fff3cd; border-left: 4px solid #ff9800; margin-bottom: 20px;">
    <h2 style="color: #856404; margin-bottom: 15px;">⚠️ Maintenance Conflict Detected</h2>
    <p style="margin-bottom: 15px;">
        <strong>The selected aircraft has scheduled maintenance:</strong>
    </p>
    <ul style="margin-bottom: 15px; padding-left: 20px;">
        <li><strong>Type:</strong> {{ maintenance_details.maintenance_type }}</li>
        <li><strong>Scheduled Date:</strong> {{ maintenance_details.scheduled_date }}</li>
        <li><strong>Status:</strong> {{ maintenance_details.status }}</li>
    </ul>
    <p style="color: #856404; font-weight: bold;">
        Scheduling this flight will override the maintenance schedule. Are you sure you want to proceed?
    </p>
</div>
{% endif %}

<div class="card">
    <form method="POST">
        {% if maintenance_warning %}
        <input type="hidden" name="override_maintenance" value="true">
        {% endif %}
        <div class="grid-2">
            <!-- Left Column -->
            <div>
                <div class="form-group">
                    <label>Select Aircraft *</label>
                    <select name="jet_id" id="jet_id" required>
                        <option value="">-- Choose Aircraft --</option>
                        {% for jet in jets %}
                            <option value="{{ jet.jet_id }}"
                                    {% if (form_data and form_data.get('jet_id') == jet.jet_id) or (flight and flight.jet_id == jet.jet_id) %}selected{% endif %}
                                    data-capacity="{{ jet.capacity }}">
                                {{ jet.model }} ({{ jet.tail_number }}) - Capacity: {{ jet.capacity }}
                            </option>
                        {% endfor %}
                    </select>
                    {% if not jets %}
                        <small style="color: #e74c3c;">No available aircraft. <a href="{{ url_for('add_jet') }}">Add an aircraft first</a></small>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label>Departure Location *</label>
                    <input type="text"
                           id="departure_search"
                           autocomplete="off"
                           value="{{ form_data.get('departure') if form_data else (flight.departure if flight else '') }}"
                           placeholder="Type city name or airport code (e.g., Los Angeles, JFK)">
                    <input type="hidden" name="departure" id="departure" required>
                    <div id="departure_suggestions" class="autocomplete-suggestions"></div>
                    <small id="departure_info" style="color: #666; display: none;"></small>
                </div>

                <div class="form-group">
                    <label>Destination Location *</label>
                    <input type="text"
                           id="destination_search"
                           autocomplete="off"
                           value="{{ form_data.get('destination') if form_data else (flight.destination if flight else '') }}"
                           placeholder="Type city name or airport code (e.g., Miami, DFW)">
                    <input type="hidden" name="destination" id="destination" required>
                    <div id="destination_suggestions" class="autocomplete-suggestions"></div>
                    <small id="destination_info" style="color: #666; display: none;"></small>
                </div>

                <div class="form-group">
                    <label>Time Selection Method</label>
                    <div style="display: flex; gap: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="time_method" value="depart_at" id="time_method_depart" checked style="margin-right: 8px;">
                            <span>I know when I want to depart</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="time_method" value="arrive_by" id="time_method_arrive" style="margin-right: 8px;">
                            <span>I know when I need to arrive</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="departure_time_group">
                    <label>Departure Time *</label>
                    <input type="datetime-local" id="departure_time_input" value="{{ form_data.get('departure_time') if form_data else (flight.departure_time.replace(' ', 'T') if flight else '') }}">
                    <input type="hidden" name="departure_time" id="departure_time" required>
                </div>

                <div class="form-group" id="arrival_time_group" style="display: none;">
                    <label>Arrival Time *</label>
                    <input type="datetime-local" id="arrival_time_input" value="{{ form_data.get('arrival_time') if form_data else (flight.arrival_time.replace(' ', 'T') if flight else '') }}">
                    <input type="hidden" name="arrival_time" id="arrival_time" required>
                </div>

                <div id="flight_duration_info" style="padding: 15px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 5px; margin-bottom: 15px; display: none;">
                    <strong style="color: #2e7d32;">Flight Information:</strong>
                    <div id="duration_display" style="margin-top: 8px; color: #1b5e20;"></div>
                </div>

                {% if flight %}
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="Scheduled" {% if flight.status == 'Scheduled' %}selected{% endif %}>Scheduled</option>
                        <option value="In Progress" {% if flight.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                        <option value="Completed" {% if flight.status == 'Completed' %}selected{% endif %}>Completed</option>
                        <option value="Cancelled" {% if flight.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
                {% endif %}
            </div>

            <!-- Right Column -->
            <div>
                <!-- Passengers Section -->
                <div class="form-group">
                    <label>Select Passengers</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn btn-success" onclick="showAddPassengerModal()" style="flex: 1;">
                            + Add New Passenger
                        </button>
                        <span id="passengerCount" style="padding: 10px; background: #f8f9fa; border-radius: 5px; font-weight: bold;">
                            0 selected
                        </span>
                    </div>
                    <select name="passengers" id="passengers" multiple size="8" style="height: 200px;">
                        {% for passenger in passengers %}
                            <option value="{{ passenger.passenger_id }}"
                                    {% if (form_data and passenger.passenger_id in form_data.getlist('passengers')) or (flight and passenger.passenger_id in flight.passenger_ids) %}selected{% endif %}>
                                {{ passenger.name }} ({{ passenger.passport_number }})
                            </option>
                        {% endfor %}
                    </select>
                    <small>Hold Ctrl (Cmd on Mac) to select multiple passengers</small>
                    {% if not passengers %}
                        <small style="color: #e74c3c; display: block; margin-top: 5px;">
                            No passengers available. Use the button above to add one.
                        </small>
                    {% endif %}
                    <small id="capacityWarning" style="color: #e74c3c; display: none; font-weight: bold; margin-top: 5px;"></small>
                </div>

                <!-- Crew Section -->
                <div class="form-group">
                    <label>Select Crew (Required: At least 1 pilot) *</label>
                    <div style="padding: 10px; background: #fff3cd; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid #ffc107;">
                        <strong>⚠️ Must include at least one PILOT!</strong>
                    </div>
                    <select name="crew" id="crew" multiple size="8" required style="height: 200px;">
                        {% for member in crew %}
                            <option value="{{ member.crew_id }}"
                                    {% if (form_data and member.crew_id in form_data.getlist('crew')) or (flight and member.crew_id in flight.crew_ids) %}selected{% endif %}
                                    data-type="{{ member.crew_type }}">
                                {{ member.name }} - {{ member.crew_type }}
                                {% if member.license_number %} ({{ member.license_number }}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                    <small>Hold Ctrl (Cmd on Mac) to select multiple crew members</small>
                    <div id="crewValidation" style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 5px; display: none;">
                        <strong style="color: #721c24;">❌ No pilot selected!</strong>
                    </div>
                    <div id="crewConfirmation" style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 5px; display: none;">
                        <strong style="color: #155724;">✅ Pilot(s) selected</strong>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ecf0f1;">
            <button type="submit" class="btn btn-primary" id="submitBtn">{{ 'Update Flight' if flight else 'Schedule Flight' }}</button>
            <a href="{{ url_for('flights') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Add Passenger Modal -->
<div id="addPassengerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
    <div style="max-width: 600px; margin: 50px auto; background: white; border-radius: 10px; padding: 30px;">
        <h2 style="margin-bottom: 20px;">Add New Passenger</h2>
        <form id="quickPassengerForm" onsubmit="addPassengerQuick(event)">
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="quick_name" required>
            </div>
            <div class="form-group">
                <label>Passport Number *</label>
                <input type="text" id="quick_passport" required>
            </div>
            <div class="form-group">
                <label>Nationality *</label>
                <input type="text" id="quick_nationality" required>
            </div>
            <div class="form-group">
                <label>Passport Expiry *</label>
                <input type="date" id="quick_expiry" required>
            </div>
            <div class="form-group">
                <label>Contact *</label>
                <input type="text" id="quick_contact" required placeholder="Email or phone">
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">Add Passenger</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddPassengerModal()" style="flex: 1;">Cancel</button>
            </div>
            <div id="modalMessage" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<style>
    .autocomplete-suggestions {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        width: calc(100% - 2px);
        display: none;
    }

    .autocomplete-suggestion {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .autocomplete-suggestion:hover {
        background: #f8f9fa;
    }

    .autocomplete-suggestion:last-child {
        border-bottom: none;
    }

    .suggestion-code {
        font-weight: bold;
        color: #2c3e50;
        font-size: 14px;
    }

    .suggestion-name {
        color: #7f8c8d;
        font-size: 13px;
        margin-top: 2px;
    }
</style>

<script>
    // Airport autocomplete state
    let departureTimeout = null;
    let destinationTimeout = null;
    let selectedDeparture = null;
    let selectedDestination = null;
    let flightDuration = null;

    // Update passenger count
    function updatePassengerCount() {
        const select = document.getElementById('passengers');
        const count = select.selectedOptions.length;
        document.getElementById('passengerCount').textContent = count + ' selected';

        // Check capacity
        const jetSelect = document.getElementById('jet_id');
        if (jetSelect.selectedIndex > 0) {
            const capacity = parseInt(jetSelect.options[jetSelect.selectedIndex].dataset.capacity);
            const warning = document.getElementById('capacityWarning');
            if (count > capacity) {
                warning.textContent = `⚠️ Warning: ${count} passengers exceeds jet capacity of ${capacity}!`;
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }
    }

    // Airport search with autocomplete
    async function searchAirports(query, callback) {
        if (query.length < 2) {
            callback([]);
            return;
        }

        try {
            const response = await fetch(`/api/airports/search?q=${encodeURIComponent(query)}&limit=10`);
            const data = await response.json();
            callback(data.results || []);
        } catch (error) {
            console.error('Airport search error:', error);
            callback([]);
        }
    }

    // Show autocomplete suggestions
    function showSuggestions(inputId, suggestionsId, results) {
        const suggestionsDiv = document.getElementById(suggestionsId);
        suggestionsDiv.innerHTML = '';

        if (results.length === 0) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        results.forEach(airport => {
            const div = document.createElement('div');
            div.className = 'autocomplete-suggestion';
            div.innerHTML = `
                <div class="suggestion-code">${airport.code}</div>
                <div class="suggestion-name">${airport.name} (${airport.city}, ${airport.state})</div>
            `;
            div.onclick = () => selectAirport(inputId, suggestionsId, airport);
            suggestionsDiv.appendChild(div);
        });

        suggestionsDiv.style.display = 'block';
    }

    // Select an airport from suggestions
    function selectAirport(inputId, suggestionsId, airport) {
        const searchInput = document.getElementById(inputId);
        const hiddenInput = document.getElementById(inputId.replace('_search', ''));
        const infoDiv = document.getElementById(inputId.replace('_search', '_info'));

        searchInput.value = airport.code;
        hiddenInput.value = airport.code;
        infoDiv.textContent = `${airport.name} (${airport.city}, ${airport.state})`;
        infoDiv.style.display = 'block';

        document.getElementById(suggestionsId).style.display = 'none';

        // Store selected airport
        if (inputId === 'departure_search') {
            selectedDeparture = airport.code;
        } else {
            selectedDestination = airport.code;
        }

        // Calculate flight duration if both airports are selected
        calculateFlightDuration();
    }

    // Setup autocomplete for an input
    function setupAutocomplete(searchInputId, hiddenInputId, suggestionsId) {
        const searchInput = document.getElementById(searchInputId);
        let timeout = null;

        searchInput.addEventListener('input', function() {
            clearTimeout(timeout);
            const query = this.value;

            timeout = setTimeout(() => {
                searchAirports(query, (results) => {
                    showSuggestions(searchInputId, suggestionsId, results);
                });
            }, 300);
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest(`#${searchInputId}`) && !e.target.closest(`#${suggestionsId}`)) {
                document.getElementById(suggestionsId).style.display = 'none';
            }
        });
    }

    // Calculate flight duration
    async function calculateFlightDuration() {
        if (!selectedDeparture || !selectedDestination) {
            return;
        }

        try {
            const response = await fetch(`/api/flights/estimate-duration?departure=${selectedDeparture}&destination=${selectedDestination}`);
            const data = await response.json();

            if (data.error) {
                console.error('Duration calculation error:', data.error);
                return;
            }

            flightDuration = data.duration_total_minutes;

            // Show flight info
            const infoDiv = document.getElementById('flight_duration_info');
            const displayDiv = document.getElementById('duration_display');
            displayDiv.innerHTML = `
                <div><strong>Estimated Flight Time:</strong> ${data.duration_text}</div>
                <div style="margin-top: 5px;"><strong>Route:</strong> ${selectedDeparture} → ${selectedDestination}</div>
            `;
            infoDiv.style.display = 'block';

            // Recalculate times if needed
            updateCalculatedTime();
        } catch (error) {
            console.error('Duration calculation error:', error);
        }
    }

    // Toggle time input method
    function toggleTimeMethod() {
        const method = document.querySelector('input[name="time_method"]:checked').value;
        const departureGroup = document.getElementById('departure_time_group');
        const arrivalGroup = document.getElementById('arrival_time_group');

        if (method === 'depart_at') {
            departureGroup.style.display = 'block';
            arrivalGroup.style.display = 'none';
            document.getElementById('departure_time_input').required = true;
            document.getElementById('arrival_time_input').required = false;
        } else {
            departureGroup.style.display = 'none';
            arrivalGroup.style.display = 'block';
            document.getElementById('departure_time_input').required = false;
            document.getElementById('arrival_time_input').required = true;
        }

        updateCalculatedTime();
    }

    // Calculate the other time based on selected method
    function updateCalculatedTime() {
        if (!flightDuration) {
            return;
        }

        const method = document.querySelector('input[name="time_method"]:checked').value;
        const departureInput = document.getElementById('departure_time_input');
        const arrivalInput = document.getElementById('arrival_time_input');
        const departureHidden = document.getElementById('departure_time');
        const arrivalHidden = document.getElementById('arrival_time');

        if (method === 'depart_at' && departureInput.value) {
            // Calculate arrival time
            const departureDate = new Date(departureInput.value);
            const arrivalDate = new Date(departureDate.getTime() + flightDuration * 60000);

            const arrivalStr = arrivalDate.toISOString().slice(0, 16);
            arrivalInput.value = arrivalStr;

            // Set hidden fields
            departureHidden.value = departureInput.value;
            arrivalHidden.value = arrivalStr;

        } else if (method === 'arrive_by' && arrivalInput.value) {
            // Calculate departure time
            const arrivalDate = new Date(arrivalInput.value);
            const departureDate = new Date(arrivalDate.getTime() - flightDuration * 60000);

            const departureStr = departureDate.toISOString().slice(0, 16);
            departureInput.value = departureStr;

            // Set hidden fields
            departureHidden.value = departureStr;
            arrivalHidden.value = arrivalInput.value;
        }
    }

    // Validate crew selection (must have pilot)
    function validateCrew() {
        const select = document.getElementById('crew');
        let hasPilot = false;

        for (let option of select.selectedOptions) {
            if (option.dataset.type === 'Pilot') {
                hasPilot = true;
                break;
            }
        }

        const validation = document.getElementById('crewValidation');
        const confirmation = document.getElementById('crewConfirmation');
        const submitBtn = document.getElementById('submitBtn');

        if (select.selectedOptions.length > 0) {
            if (hasPilot) {
                validation.style.display = 'none';
                confirmation.style.display = 'block';
                submitBtn.disabled = false;
            } else {
                validation.style.display = 'block';
                confirmation.style.display = 'none';
                submitBtn.disabled = true;
            }
        } else {
            validation.style.display = 'none';
            confirmation.style.display = 'none';
            submitBtn.disabled = false;
        }
    }

    // Event listeners
    document.getElementById('passengers').addEventListener('change', updatePassengerCount);
    document.getElementById('crew').addEventListener('change', validateCrew);
    document.getElementById('jet_id').addEventListener('change', updatePassengerCount);

    // Time method toggle listeners
    document.getElementById('time_method_depart').addEventListener('change', toggleTimeMethod);
    document.getElementById('time_method_arrive').addEventListener('change', toggleTimeMethod);

    // Time input listeners for calculation
    document.getElementById('departure_time_input').addEventListener('change', updateCalculatedTime);
    document.getElementById('arrival_time_input').addEventListener('change', updateCalculatedTime);

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Setup autocomplete for both airport fields
        setupAutocomplete('departure_search', 'departure', 'departure_suggestions');
        setupAutocomplete('destination_search', 'destination', 'destination_suggestions');

        // Initialize existing values if editing
        const departureSearch = document.getElementById('departure_search');
        const destinationSearch = document.getElementById('destination_search');

        if (departureSearch.value) {
            selectedDeparture = departureSearch.value;
            document.getElementById('departure').value = departureSearch.value;
        }

        if (destinationSearch.value) {
            selectedDestination = destinationSearch.value;
            document.getElementById('destination').value = destinationSearch.value;
        }

        // Calculate duration if both are set
        if (selectedDeparture && selectedDestination) {
            calculateFlightDuration();
        }

        updatePassengerCount();
        validateCrew();
    });

    // Modal functions
    function showAddPassengerModal() {
        document.getElementById('addPassengerModal').style.display = 'block';
    }

    function closeAddPassengerModal() {
        document.getElementById('addPassengerModal').style.display = 'none';
        document.getElementById('quickPassengerForm').reset();
        document.getElementById('modalMessage').style.display = 'none';
    }

    // Add passenger via AJAX
    async function addPassengerQuick(event) {
        event.preventDefault();

        const data = {
            name: document.getElementById('quick_name').value,
            passport_number: document.getElementById('quick_passport').value,
            nationality: document.getElementById('quick_nationality').value,
            passport_expiry: document.getElementById('quick_expiry').value,
            contact: document.getElementById('quick_contact').value
        };

        try {
            const response = await fetch('/api/passengers/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                // Add to dropdown
                const select = document.getElementById('passengers');
                const option = document.createElement('option');
                option.value = result.passenger_id;
                option.text = `${result.name} (${result.passport_number})`;
                option.selected = true;
                select.appendChild(option);

                // Show success message
                const msg = document.getElementById('modalMessage');
                msg.textContent = '✅ Passenger added successfully!';
                msg.style.background = '#d4edda';
                msg.style.color = '#155724';
                msg.style.display = 'block';

                updatePassengerCount();

                // Close modal after 1 second
                setTimeout(() => {
                    closeAddPassengerModal();
                }, 1000);
            } else {
                throw new Error(result.error || 'Failed to add passenger');
            }
        } catch (error) {
            const msg = document.getElementById('modalMessage');
            msg.textContent = '❌ Error: ' + error.message;
            msg.style.background = '#f8d7da';
            msg.style.color = '#721c24';
            msg.style.display = 'block';
        }
    }

    // Close modal when clicking outside
    document.getElementById('addPassengerModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeAddPassengerModal();
        }
    });
</script>
{% endblock %}
