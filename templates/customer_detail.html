{% extends "base.html" %}

{% block title %}{{ customer.name }} - Customer Details - Manajet{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1>Customer Details</h1>
    <div class="button-group">
        <a href="{{ url_for('edit_customer', customer_id=customer.customer_id) }}" class="btn btn-primary">Edit Customer</a>
        <a href="{{ url_for('customers') }}" class="btn">Back to List</a>
    </div>
</div>

<!-- Customer Information -->
<div class="card">
    <h2>Customer Information</h2>
    <div class="detail-grid">
        <div class="detail-item">
            <strong>Customer ID:</strong>
            <span>{{ customer.customer_id }}</span>
        </div>
        <div class="detail-item">
            <strong>Name:</strong>
            <span>{{ customer.name }}</span>
        </div>
        <div class="detail-item">
            <strong>Company:</strong>
            <span>{{ customer.company }}</span>
        </div>
        <div class="detail-item">
            <strong>Email:</strong>
            <span><a href="mailto:{{ customer.email }}">{{ customer.email }}</a></span>
        </div>
        <div class="detail-item">
            <strong>Phone:</strong>
            <span><a href="tel:{{ customer.phone }}">{{ customer.phone }}</a></span>
        </div>
        <div class="detail-item">
            <strong>Address:</strong>
            <span>{{ customer.address }}</span>
        </div>
        {% if customer_user %}
        <div class="detail-item">
            <strong>User Account:</strong>
            <span><span class="status-badge status-completed">{{ customer_user.username }}</span></span>
        </div>
        {% else %}
        <div class="detail-item">
            <strong>User Account:</strong>
            <span><span class="status-badge" style="background: #999;">No account created</span></span>
        </div>
        {% endif %}
    </div>
</div>

<!-- Summary Stats -->
<div class="grid-3" style="margin-top: 30px;">
    <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
        <h3 style="margin-bottom: 10px; font-size: 16px; opacity: 0.9;">Total Aircraft</h3>
        <div style="font-size: 36px; font-weight: bold;">{{ customer_jets|length }}</div>
    </div>
    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h3 style="margin-bottom: 10px; font-size: 16px; opacity: 0.9;">Total Passengers</h3>
        <div style="font-size: 36px; font-weight: bold;">{{ customer_passengers|length }}</div>
    </div>
    <div class="card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
        <h3 style="margin-bottom: 10px; font-size: 16px; opacity: 0.9;">Available Unassigned</h3>
        <div style="font-size: 18px; font-weight: bold; margin-top: 10px;">
            {{ unassigned_jets|length }} Aircraft<br>
            {{ unassigned_passengers|length }} Passengers
        </div>
    </div>
</div>

<!-- Associated Aircraft -->
<div class="card" style="margin-top: 30px;">
    <h2>Associated Aircraft <span style="color: #10b981; font-size: 14px;">(‚úì Supports Shared Ownership)</span></h2>
    {% if customer_jets %}
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Aircraft ID</th>
                        <th>Model</th>
                        <th>Tail Number</th>
                        <th>Capacity</th>
                        <th>Co-Owners</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for jet in customer_jets %}
                    <tr>
                        <td><strong>{{ jet.jet_id }}</strong></td>
                        <td>{{ jet.model }}</td>
                        <td>{{ jet.tail_number }}</td>
                        <td>{{ jet.capacity }} passengers</td>
                        <td>
                            {% set other_owners = [] %}
                            {% for cid in jet.customer_ids %}
                                {% if cid != customer.customer_id %}
                                    {% set co_owner = manager.get_customer(cid) %}
                                    {% if co_owner %}
                                        {% set _ = other_owners.append(co_owner.name) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            {% if other_owners|length > 0 %}
                                <span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                                    ü§ù SHARED
                                </span>
                                <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                    with {{ other_owners|join(', ') }}
                                </div>
                            {% else %}
                                <span style="color: #888;">‚Äî</span>
                            {% endif %}
                        </td>
                        <td><span class="status-badge status-{{ jet.status.lower().replace(' ', '-') }}">{{ jet.status }}</span></td>
                        <td>
                            <form method="POST" action="{{ url_for('unassign_jet_from_customer', customer_id=customer.customer_id, jet_id=jet.jet_id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-small btn-warning" onclick="return confirm('Remove this aircraft from {{ customer.name }}?');">
                                    Unassign
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="color: #888; text-align: center; padding: 20px;">No aircraft assigned to this customer</p>
    {% endif %}

    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
        <h3 style="margin-bottom: 15px;">Assign Aircraft (Including Shared)</h3>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            You can assign any aircraft, even those already owned by other customers for shared ownership.
        </p>
        <form method="POST" action="{{ url_for('assign_jet_to_customer', customer_id=customer.customer_id) }}" style="display: flex; gap: 10px; align-items: end;">
            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                <label for="jet_id">Select Aircraft to Assign</label>
                <select name="jet_id" id="jet_id" required>
                    <option value="">-- Choose Aircraft --</option>
                    {% for jet in manager.jets.values() %}
                        {% if customer.customer_id not in jet.customer_ids %}
                            {% set owner_names = [] %}
                            {% for cid in jet.customer_ids %}
                                {% set owner = manager.get_customer(cid) %}
                                {% if owner %}
                                    {% set _ = owner_names.append(owner.name) %}
                                {% endif %}
                            {% endfor %}
                            <option value="{{ jet.jet_id }}">
                                {{ jet.model }} ({{ jet.tail_number }})
                                {% if owner_names|length > 0 %} - Shared with: {{ owner_names|join(', ') }}{% else %} - Unassigned{% endif %}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-success">Assign Aircraft</button>
        </form>
    </div>
</div>

<!-- Associated Passengers -->
<div class="card" style="margin-top: 30px;">
    <h2>Associated Passengers</h2>
    {% if customer_passengers %}
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Passenger ID</th>
                        <th>Name</th>
                        <th>Passport Number</th>
                        <th>Nationality</th>
                        <th>Contact</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for passenger in customer_passengers %}
                    <tr>
                        <td><strong>{{ passenger.passenger_id }}</strong></td>
                        <td>{{ passenger.name }}</td>
                        <td>{{ passenger.passport_number }}</td>
                        <td>{{ passenger.nationality }}</td>
                        <td>{{ passenger.contact }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('unassign_passenger_from_customer', customer_id=customer.customer_id, passenger_id=passenger.passenger_id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-small btn-warning" onclick="return confirm('Remove {{ passenger.name }} from {{ customer.name }}?');">
                                    Unassign
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="color: #888; text-align: center; padding: 20px;">No passengers assigned to this customer</p>
    {% endif %}

    {% if unassigned_passengers %}
    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
        <h3 style="margin-bottom: 15px;">Assign New Passenger</h3>
        <form method="POST" action="{{ url_for('assign_passenger_to_customer', customer_id=customer.customer_id) }}" style="display: flex; gap: 10px; align-items: end;">
            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                <label for="passenger_id">Select Passenger to Assign</label>
                <select name="passenger_id" id="passenger_id" required>
                    <option value="">-- Choose Passenger --</option>
                    {% for passenger in unassigned_passengers %}
                        <option value="{{ passenger.passenger_id }}">{{ passenger.name }} ({{ passenger.passport_number }})</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-success">Assign Passenger</button>
        </form>
    </div>
    {% endif %}
</div>

<style>
.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.detail-item strong {
    color: #666;
    font-size: 14px;
}

.detail-item span {
    font-size: 16px;
}

.button-group {
    display: flex;
    gap: 10px;
}

.btn-small {
    padding: 5px 10px;
    font-size: 13px;
}

.btn-warning {
    background: #ffa726;
}

.btn-warning:hover {
    background: #fb8c00;
}

.grid-3 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

@media (max-width: 768px) {
    .button-group {
        flex-direction: column;
        width: 100%;
    }

    .button-group .btn {
        width: 100%;
    }

    .table-responsive {
        overflow-x: auto;
    }

    table {
        min-width: 600px;
    }

    .grid-3 {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
